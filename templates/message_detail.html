<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Message Details - Telegram Job Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      .message-content {
        background-color: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        white-space: pre-wrap;
        word-wrap: break-word;
        line-height: 1.6;
      }
      .message-content a {
        color: #007bff;
        text-decoration: underline;
      }
      .message-content a:hover {
        color: #0056b3;
      }
      .message-content strong {
        color: #495057;
      }
      .info-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }
      .badge-relevant {
        background-color: #28a745;
      }
      .badge-uncategorized {
        background-color: #6c757d;
      }
      .link-item {
        background-color: #e9ecef;
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 10px;
        transition: background-color 0.2s;
      }
      .link-item:hover {
        background-color: #dee2e6;
      }
      .copy-btn {
        cursor: pointer;
        transition: color 0.2s;
      }
      .copy-btn:hover {
        color: #007bff;
      }
      .quick-stats {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
      }
      .stat-item {
        background: #e9ecef;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 0.875rem;
      }
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
      }
    </style>
  </head>
  <body>
    <!-- Loading overlay -->
    <div class="loading-overlay" id="loadingOverlay">
      <div class="text-center">
        <i class="fas fa-spinner fa-spin fa-3x text-primary"></i>
        <p class="mt-3">Loading message details...</p>
      </div>
    </div>

    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container">
        <a class="navbar-brand" href="/">
          <i class="fas fa-briefcase"></i> Telegram Job Dashboard
        </a>
        <div class="navbar-nav ms-auto">
          <a class="nav-link" href="/">
            <i class="fas fa-arrow-left"></i> Back to Dashboard
          </a>
        </div>
      </div>
    </nav>

    <div class="container mt-4">
      <div class="row">
        <!-- Message Info -->
        <div class="col-md-4">
          <div class="card info-card mb-4">
            <div class="card-body">
              <h5 class="card-title">
                <i class="fas fa-info-circle"></i> Message Info
              </h5>
              <hr class="border-light" />
              <p><strong>Source:</strong><br />{{ message['Source Group'] }}</p>
              <p>
                <strong>Date:</strong><br />{{ message['Message Date'] }} {{
                message['Message Time'] }}
              </p>
              <p>
                <strong>Category:</strong><br />
                <span
                  class="badge {% if message.Category == 'Relevant' %}badge-relevant{% else %}badge-uncategorized{% endif %}"
                >
                  {{ message.Category }}
                </span>
              </p>
              <p>
                <strong>Message ID:</strong><br />
                <small class="font-monospace"
                  >{{ message['Message ID'] }}</small
                >
                <i
                  class="fas fa-copy copy-btn ms-2"
                  onclick="copyToClipboard('{{ message['Message ID'] }}')"
                  title="Copy ID"
                ></i>
              </p>
            </div>
          </div>

          <!-- Quick Stats -->
          <div class="card mb-4">
            <div class="card-body">
              <h6 class="card-title">
                <i class="fas fa-chart-bar"></i> Quick Stats
              </h6>
              <div class="quick-stats" id="quickStats">
                <div class="stat-item">
                  <i class="fas fa-align-left"></i>
                  <span id="wordCount"
                    >{{ message['Full Message'].split()|length }}</span
                  >
                  words
                </div>
                <div class="stat-item">
                  <i class="fas fa-link"></i>
                  <span id="linkCount"
                    >{{ message.extracted_links|length if
                    message.extracted_links else 0 }}</span
                  >
                  links
                </div>
              </div>
            </div>
          </div>

          <!-- Links Section -->
          {% if message.extracted_links and message.extracted_links|length > 0
          %}
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">
                <i class="fas fa-link"></i> Extracted Links ({{
                message.extracted_links|length }})
              </h5>
              <hr />
              {% for link in message.extracted_links %}
              <div class="link-item">
                <div class="d-flex justify-content-between align-items-center">
                  <div class="flex-grow-1">
                    <small class="text-break d-block">{{ link }}</small>
                    <small class="text-muted">
                      {% if 'linkedin' in link.lower() %}
                      <i class="fab fa-linkedin text-primary"></i> LinkedIn {%
                      elif 'forms.gle' in link.lower() or 'forms.google' in
                      link.lower() %}
                      <i class="fab fa-google text-success"></i> Google Form {%
                      elif 't.me' in link.lower() %}
                      <i class="fab fa-telegram text-info"></i> Telegram {% else
                      %} <i class="fas fa-external-link-alt"></i> External Link
                      {% endif %}
                    </small>
                  </div>
                  <div class="ms-2">
                    <a
                      href="{{ link }}"
                      target="_blank"
                      class="btn btn-sm btn-primary me-1"
                      title="Open link"
                    >
                      <i class="fas fa-external-link-alt"></i>
                    </a>
                    <i
                      class="fas fa-copy copy-btn"
                      onclick="copyToClipboard('{{ link }}')"
                      title="Copy link"
                    ></i>
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
          {% endif %}
        </div>

        <!-- Message Content -->
        <div class="col-md-8">
          <div class="card">
            <div class="card-body">
              <div
                class="d-flex justify-content-between align-items-center mb-3"
              >
                <h5 class="card-title">
                  <i class="fas fa-comment-alt"></i> Full Message
                </h5>
                <div>
                  <button
                    class="btn btn-outline-secondary btn-sm me-2"
                    onclick="copyMessage()"
                  >
                    <i class="fas fa-copy"></i> Copy Message
                  </button>
                  <button
                    class="btn btn-outline-primary btn-sm"
                    onclick="toggleFormatting()"
                  >
                    <i class="fas fa-code" id="formatIcon"></i>
                    <span id="formatText">Raw Text</span>
                  </button>
                </div>
              </div>
              <div class="message-content" id="messageContent">
                {{ message.formatted_message|safe if message.formatted_message
                else message['Full Message'] }}
              </div>
            </div>
          </div>

          <!-- Actions -->
          <div class="card mt-4">
            <div class="card-body">
              <h6 class="card-title">Actions</h6>
              <div class="btn-group" role="group">
                <button class="btn btn-success" onclick="markAsRelevant()">
                  <i class="fas fa-thumbs-up"></i> Mark as Relevant
                </button>
                <button
                  class="btn btn-secondary"
                  onclick="markAsUncategorized()"
                >
                  <i class="fas fa-question"></i> Mark as Uncategorized
                </button>
                <button class="btn btn-info" onclick="exportMessage()">
                  <i class="fas fa-download"></i> Export
                </button>
                <button class="btn btn-warning" onclick="shareMessage()">
                  <i class="fas fa-share"></i> Share
                </button>
              </div>
            </div>
          </div>

          <!-- Analysis Section -->
          <div class="card mt-4">
            <div class="card-body">
              <h6 class="card-title">
                <i class="fas fa-search"></i> Quick Analysis
              </h6>
              <div id="analysisResults">
                <div class="text-muted">
                  Click "Analyze" to get insights about this message
                </div>
              </div>
              <button
                class="btn btn-outline-primary mt-2"
                onclick="analyzeMessage()"
              >
                <i class="fas fa-cog"></i> Analyze Message
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Success/Error Messages -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1050">
      <div id="alertContainer"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
      let isFormatted = true;
      const originalMessage = `{{ message['Full Message']|safe }}`;
      const formattedMessage = `{{ message.formatted_message|safe if message.formatted_message else message['Full Message']|safe }}`;

      // Hide loading overlay once page is loaded
      document.addEventListener('DOMContentLoaded', function() {
          document.getElementById('loadingOverlay').style.display = 'none';
          makeLinksClickable();
          highlightKeywords();
      });

      function makeLinksClickable() {
          const messageContent = document.getElementById('messageContent');
          let html = messageContent.innerHTML;

          // Enhanced URL regex to catch more patterns
          const urlRegex = /(https?:\/\/[^\s<>"{}|\\^`\[\]]+|www\.[^\s<>"{}|\\^`\[\]]+|[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}\/[^\s<>"{}|\\^`\[\]]*)/g;

          html = html.replace(urlRegex, function(url) {
              let href = url;
              if (!url.startsWith('http')) {
                  href = 'https://' + url;
              }
              return `<a href="${href}" target="_blank" class="text-primary">${url}</a>`;
          });

          messageContent.innerHTML = html;
      }

      function toggleFormatting() {
          const messageContent = document.getElementById('messageContent');
          const formatIcon = document.getElementById('formatIcon');
          const formatText = document.getElementById('formatText');

          if (isFormatted) {
              messageContent.innerHTML = originalMessage;
              formatIcon.className = 'fas fa-markdown';
              formatText.textContent = 'Formatted';
              isFormatted = false;
          } else {
              messageContent.innerHTML = marked.parse(formattedMessage);
              formatIcon.className = 'fas fa-code';
              formatText.textContent = 'Raw Text';
              isFormatted = true;
          }

          makeLinksClickable();
          highlightKeywords();
      }

      function copyToClipboard(text) {
          navigator.clipboard.writeText(text).then(function() {
              showAlert('Copied to clipboard!', 'success');
          }).catch(function(err) {
              console.error('Could not copy text: ', err);
              showAlert('Failed to copy', 'danger');
          });
      }

      function copyMessage() {
          const messageContent = document.getElementById('messageContent').textContent;
          copyToClipboard(messageContent);
      }

      function shareMessage() {
          if (navigator.share) {
              navigator.share({
                  title: 'Job Message from {{ message["Source Group"] }}',
                  text: originalMessage.substring(0, 200) + '...',
                  url: window.location.href
              });
          } else {
              copyToClipboard(window.location.href);
              showAlert('Link copied to clipboard!', 'info');
          }
      }

      function showAlert(message, type) {
          const alertContainer = document.getElementById('alertContainer');
          const alertId = 'alert-' + Date.now();

          const alertHTML = `
              <div class="alert alert-${type} alert-dismissible fade show" id="${alertId}" role="alert">
                  ${message}
                  <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
              </div>
          `;

          alertContainer.innerHTML = alertHTML;

          // Auto-dismiss after 3 seconds
          setTimeout(() => {
              const alert = document.getElementById(alertId);
              if (alert) {
                  const bsAlert = new bootstrap.Alert(alert);
                  bsAlert.close();
              }
          }, 3000);
      }

      function markAsRelevant() {
          showAlert('Message marked as relevant (feature not implemented)', 'info');
      }

      function markAsUncategorized() {
          showAlert('Message marked as uncategorized (feature not implemented)', 'info');
      }

      function exportMessage() {
          const messageData = {
              id: '{{ message["Message ID"] }}',
              source: '{{ message["Source Group"] }}',
              date: '{{ message["Message Date"] }}',
              time: '{{ message["Message Time"] }}',
              category: '{{ message.Category }}',
              message: originalMessage,
              links: {{ message.extracted_links|tojson if message.extracted_links else '[]' }}
          };

          const dataStr = JSON.stringify(messageData, null, 2);
          const dataBlob = new Blob([dataStr], {type: 'application/json'});
          const url = URL.createObjectURL(dataBlob);
          const link = document.createElement('a');
          link.href = url;
          link.download = `message_${messageData.id}.json`;
          link.click();
          URL.revokeObjectURL(url);

          showAlert('Message exported successfully', 'success');
      }

      function analyzeMessage() {
          const messageText = originalMessage;
          const analysisContainer = document.getElementById('analysisResults');

          // Show loading
          analysisContainer.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Analyzing...</div>';

          // Simulate analysis delay for better UX
          setTimeout(() => {
              const analysis = performBasicAnalysis(messageText);
              displayAnalysis(analysis);
          }, 500);
      }

      function performBasicAnalysis(text) {
          const textLower = text.toLowerCase();

          const jobKeywords = [
              'hiring', 'vacancy', 'opening', 'position', 'job', 'opportunity',
              'recruitment', 'apply', 'career', 'placement', 'interview', 'urgent'
          ].filter(keyword => textLower.includes(keyword));

          const experienceKeywords = [
              'fresher', 'freshman', '2025 batch', '2024 batch', 'entry level',
              'campus', 'graduate', 'intern', 'trainee', '0-1 year', '0-2 year'
          ].filter(keyword => textLower.includes(keyword));

          const techSkills = [
              'python', 'java', 'javascript', 'react', 'node', 'sql', 'mongodb',
              'aws', 'docker', 'kubernetes', 'angular', 'vue', 'php', 'golang'
          ].filter(skill => textLower.includes(skill));

          // Enhanced company detection
          const companyIndicators = /\b[A-Z][a-z]+ (?:Company|Corp|Corporation|Ltd|Limited|Inc|Technologies|Tech|Solutions|Systems|Labs|Group)\b/g;
          const possibleCompanies = (text.match(companyIndicators) || []).slice(0, 3);

          // Salary detection
          const salaryPatterns = [
              /â‚¹\s*[\d,.]+ (?:lakh|LPA|per annum)/gi,
              /\$\s*[\d,.]+ (?:per year|annually)/gi,
              /\b\d+\s*-\s*\d+\s*(?:lakh|LPA)\b/gi
          ];

          let salaryMentions = [];
          salaryPatterns.forEach(pattern => {
              const matches = text.match(pattern);
              if (matches) salaryMentions.push(...matches);
          });

          return {
              jobKeywords,
              experienceKeywords,
              techSkills,
              possibleCompanies,
              salaryMentions: salaryMentions.slice(0, 3),
              wordCount: text.split(/\s+/).length,
              sentiment: determineSentiment(textLower)
          };
      }

      function determineSentiment(text) {
          const urgentWords = ['urgent', 'immediate', 'asap', 'quickly'];
          const positiveWords = ['excellent', 'great', 'amazing', 'opportunity'];

          const hasUrgent = urgentWords.some(word => text.includes(word));
          const hasPositive = positiveWords.some(word => text.includes(word));

          if (hasUrgent) return { type: 'urgent', color: 'warning' };
          if (hasPositive) return { type: 'positive', color: 'success' };
          return { type: 'neutral', color: 'info' };
      }

      function displayAnalysis(analysis) {
          const analysisContainer = document.getElementById('analysisResults');

          let html = '<div class="row">';

          // Job indicators
          if (analysis.jobKeywords.length > 0) {
              html += `
                  <div class="col-md-6 mb-3">
                      <h6><i class="fas fa-briefcase text-primary"></i> Job Keywords Found:</h6>
                      <div>
                          ${analysis.jobKeywords.map(keyword =>
                              `<span class="badge bg-primary me-1">${keyword}</span>`
                          ).join('')}
                      </div>
                  </div>
              `;
          }

          // Experience indicators
          if (analysis.experienceKeywords.length > 0) {
              html += `
                  <div class="col-md-6 mb-3">
                      <h6><i class="fas fa-graduation-cap text-success"></i> Experience Level:</h6>
                      <div>
                          ${analysis.experienceKeywords.map(keyword =>
                              `<span class="badge bg-success me-1">${keyword}</span>`
                          ).join('')}
                      </div>
                  </div>
              `;
          }

          // Tech skills
          if (analysis.techSkills.length > 0) {
              html += `
                  <div class="col-md-6 mb-3">
                      <h6><i class="fas fa-code text-info"></i> Tech Skills:</h6>
                      <div>
                          ${analysis.techSkills.map(skill =>
                              `<span class="badge bg-info me-1">${skill}</span>`
                          ).join('')}
                      </div>
                  </div>
              `;
          }

          // Companies
          if (analysis.possibleCompanies.length > 0) {
              html += `
                  <div class="col-md-6 mb-3">
                      <h6><i class="fas fa-building text-warning"></i> Possible Companies:</h6>
                      <div>
                          ${analysis.possibleCompanies.map(company =>
                              `<span class="badge bg-warning text-dark me-1">${company}</span>`
                          ).join('')}
                      </div>
                  </div>
              `;
          }

          // Salary mentions
          if (analysis.salaryMentions.length > 0) {
              html += `
                  <div class="col-md-12 mb-3">
                      <h6><i class="fas fa-money-bill-wave text-success"></i> Salary Information:</h6>
                      <div>
                          ${analysis.salaryMentions.map(salary =>
                              `<span class="badge bg-success me-1">${salary}</span>`
                          ).join('')}
                      </div>
                  </div>
              `;
          }

          // Sentiment
          html += `
              <div class="col-md-12 mb-3">
                  <h6><i class="fas fa-smile text-${analysis.sentiment.color}"></i> Message Tone:</h6>
                  <span class="badge bg-${analysis.sentiment.color}">${analysis.sentiment.type}</span>
              </div>
          `;

          html += '</div>';

          if (analysis.jobKeywords.length === 0 && analysis.experienceKeywords.length === 0) {
              html = '<div class="text-muted">No significant job-related keywords found in this message.</div>';
          }

          analysisContainer.innerHTML = html;
      }

      function highlightKeywords() {
          const messageContent = document.getElementById('messageContent');
          let html = messageContent.innerHTML;

          // Highlight job-related keywords
          const jobKeywords = ['hiring', 'vacancy', 'opening', 'position', 'job', 'opportunity'];
          jobKeywords.forEach(keyword => {
              const regex = new RegExp(`\\b${keyword}\\b`, 'gi');
              html = html.replace(regex, `<mark class="bg-primary text-white">$&</mark>`);
          });

          // Highlight experience keywords
          const expKeywords = ['fresher', 'freshman', '2025', '2024', 'entry level', 'campus'];
          expKeywords.forEach(keyword => {
              const regex = new RegExp(`\\b${keyword}\\b`, 'gi');
              html = html.replace(regex, `<mark class="bg-success text-white">$&</mark>`);
          });

          messageContent.innerHTML = html;
      }
    </script>
  </body>
</html>
